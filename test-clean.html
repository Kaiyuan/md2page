<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>清理版本测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 0.5rem;
        }
        
        #test-results {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        #test-results p {
            margin: 0.5rem 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>清理版本类库测试</h1>
    <div id="test-results">
        <p>正在测试清理版本的类库...</p>
    </div>

    <!-- 引入 marked.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <!-- 应用脚本 - 使用清理版本 -->
    <script src="./js/classes-clean.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resultsDiv = document.getElementById('test-results');
            
            function addResult(message, type = 'info') {
                const p = document.createElement('p');
                p.textContent = message;
                p.className = type;
                resultsDiv.appendChild(p);
                console.log(message);
            }
            
            addResult('页面加载完成，开始测试清理版本...', 'info');
            
            // 检查依赖库
            if (typeof marked === 'undefined') {
                addResult('❌ marked.js 库未加载', 'error');
                return;
            } else {
                addResult('✅ marked.js 库加载成功', 'success');
            }
            
            // 测试类定义
            const classTests = [
                ['MarkdownConverter', MarkdownConverter],
                ['FileHandler', FileHandler],
                ['ThemeManager', ThemeManager],
                ['PrintOptimizer', PrintOptimizer],
                ['ErrorHandler', ErrorHandler]
            ];
            
            let allClassesDefined = true;
            
            classTests.forEach(([name, cls]) => {
                if (typeof cls === 'function') {
                    addResult(`✅ ${name} 类定义正确`, 'success');
                } else {
                    addResult(`❌ ${name} 类未定义或不是函数`, 'error');
                    allClassesDefined = false;
                }
            });
            
            if (!allClassesDefined) {
                addResult('❌ 部分类未正确定义，停止测试', 'error');
                return;
            }
            
            // 测试实例创建
            addResult('开始测试实例创建...', 'info');
            
            try {
                const converter = new MarkdownConverter();
                addResult('✅ MarkdownConverter 实例创建成功', 'success');
                
                const fileHandler = new FileHandler();
                addResult('✅ FileHandler 实例创建成功', 'success');
                
                const themeManager = new ThemeManager();
                addResult('✅ ThemeManager 实例创建成功', 'success');
                
                const printOptimizer = new PrintOptimizer();
                addResult('✅ PrintOptimizer 实例创建成功', 'success');
                
                const errorHandler = new ErrorHandler();
                addResult('✅ ErrorHandler 实例创建成功', 'success');
                
                addResult('🎉 所有类都正常工作！', 'success');
                
                // 测试基本功能
                addResult('开始测试基本功能...', 'info');
                const testMarkdown = '# 测试标题\n\n这是一个测试段落。\n\n## 二级标题\n\n- 列表项1\n- 列表项2';
                const html = converter.parseMarkdown(testMarkdown);
                
                if (html && html.includes('<h1') && html.includes('<h2') && html.includes('<ul>')) {
                    addResult('✅ Markdown 解析测试成功', 'success');
                    addResult(`解析结果预览: ${html.substring(0, 100)}...`, 'info');
                } else {
                    addResult('❌ Markdown 解析测试失败', 'error');
                }
                
                // 测试主题管理
                const currentTheme = themeManager.getCurrentTheme();
                addResult(`✅ 当前主题: ${currentTheme}`, 'success');
                
                // 测试文件名生成
                const filename = fileHandler.generateFilename(html);
                addResult(`✅ 生成文件名: ${filename}`, 'success');
                
                addResult('🎉 所有测试完成！清理版本工作正常！', 'success');
                
            } catch (error) {
                addResult(`❌ 测试失败: ${error.message}`, 'error');
                console.error('详细错误:', error);
            }
        });
        
        // 全局错误处理
        window.addEventListener('error', function(e) {
            const resultsDiv = document.getElementById('test-results');
            if (resultsDiv) {
                const p = document.createElement('p');
                p.textContent = `❌ 全局错误: ${e.message}`;
                p.className = 'error';
                resultsDiv.appendChild(p);
            }
            console.error('全局错误:', e);
        });
    </script>
</body>
</html>